var WebSocketWithHeartbeat=function(){"use strict";const t={heartbeatInterval:3e4,reconnectInterval:5e3,maxReconnectAttempts:0,maxReconnectInterval:5e3,timeout:5e3,debug:!1,heartbeatInitiator:"client",singleton:!1};class e{static instance=null;heartbeatInterval;reconnectInterval;maxReconnectAttempts;maxReconnectInterval;timeout;debug;heartbeatInitiator;singleton;url;heartbeatTimer=null;heartbeatCheckTimer=null;reconnectTimer=null;reconnectAttempts=0;initialReconnectInterval;ws=null;onopen=()=>{};onmessage=()=>{};onclose=()=>{};onerror=()=>{};constructor(n,s={}){const a={...t,...s};if(this.heartbeatInterval=a.heartbeatInterval,this.reconnectInterval=a.reconnectInterval,this.maxReconnectAttempts=a.maxReconnectAttempts,this.maxReconnectInterval=a.maxReconnectInterval,this.timeout=a.timeout,this.debug=a.debug,this.heartbeatInitiator=a.heartbeatInitiator,this.singleton=a.singleton,this.url=n.replace(/^http/,"ws"),this.initialReconnectInterval=this.reconnectInterval,this.singleton&&e.instance)return e.instance;this.connect()}connect(){this.ws=new WebSocket(this.url),this.ws.onopen=()=>this.onOpen(),this.ws.onmessage=t=>this.onMessage(t),this.ws.onclose=()=>this.onClose(),this.ws.onerror=t=>this.onError(t)}onOpen(){this.onopen(),this.log("WebSocket连接已建立"),this.reconnectAttempts=0,this.reconnectInterval=this.initialReconnectInterval,"client"===this.heartbeatInitiator?this.startHeartbeat():this.startHeartbeatCheck()}onMessage(t){try{const e=JSON.parse(t.data);this.log("收到服务器消息:",e),"heartbeat"===e.type?"client"===this.heartbeatInitiator?this.resetHeartbeat():this.resetHeartbeatCheck():this.onmessage(t)}catch(t){this.log(t)}}onClose(){this.onclose(),this.log("WebSocket连接已关闭，尝试重连..."),this.cleanup(),this.reconnect()}onError(t){this.onerror(t),this.log("WebSocket错误:",t)}send(t){this.ws?.readyState===WebSocket.OPEN?(this.ws.send(t),this.log("发送消息:",t)):this.log("WebSocket 连接未打开，无法发送消息")}startHeartbeat(){this.stopHeartbeat(),this.heartbeatTimer=setInterval((()=>{if(this.ws?.readyState===WebSocket.OPEN){const t={type:"heartbeat",data:"ping"};this.ws.send(JSON.stringify(t)),this.log("发送心跳消息:",t)}}),this.heartbeatInterval)}startHeartbeatCheck(){this.stopHeartbeatCheck(),this.heartbeatCheckTimer=setTimeout((()=>{this.log("心跳超时，连接断开，尝试重连..."),this.onClose()}),this.heartbeatInterval+this.timeout)}resetHeartbeat(){this.stopHeartbeat(),this.startHeartbeat()}resetHeartbeatCheck(){this.stopHeartbeatCheck(),this.startHeartbeatCheck()}stopHeartbeat(){null!==this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}stopHeartbeatCheck(){null!==this.heartbeatCheckTimer&&(clearTimeout(this.heartbeatCheckTimer),this.heartbeatCheckTimer=null)}cleanup(){this.stopHeartbeat(),this.stopHeartbeatCheck(),null!==this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}log(...t){this.debug&&console.log(...t)}reconnect(){0===this.maxReconnectAttempts||this.reconnectAttempts<this.maxReconnectAttempts?null===this.reconnectTimer&&(this.reconnectTimer=setTimeout((()=>{this.reconnectAttempts++,this.reconnectInterval=Math.min(this.reconnectInterval+=this.initialReconnectInterval,this.maxReconnectInterval),this.connect(),this.reconnectTimer=null}),this.reconnectInterval)):this.log("达到最大重连次数，停止重连")}}return e}();
